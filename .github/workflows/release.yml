name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM (Apple Silicon)
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            rust_target: 'aarch64-apple-darwin'
            arch: 'aarch64'
          # macOS Intel
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            rust_target: 'x86_64-apple-darwin'
            arch: 'x86_64'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/ui/src-tauri

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app
        run: pnpm tauri build ${{ matrix.args }}
        working-directory: apps/ui

      - name: Find DMG and calculate SHA256
        id: dmg_info
        run: |
          # Find the DMG file
          DMG_PATH=$(find apps/ui/src-tauri/target -name "*.dmg" -type f | head -1)
          echo "Found DMG: $DMG_PATH"
          
          # Get filename
          DMG_NAME=$(basename "$DMG_PATH")
          echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT
          echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT
          
          # Calculate SHA256
          SHA256=$(shasum -a 256 "$DMG_PATH" | cut -d ' ' -f 1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmg-${{ matrix.arch }}
          path: ${{ steps.dmg_info.outputs.dmg_path }}

      - name: Save SHA256 to file
        run: echo "${{ steps.dmg_info.outputs.sha256 }}" > sha256-${{ matrix.arch }}.txt

      - name: Upload SHA256 artifact
        uses: actions/upload-artifact@v4
        with:
          name: sha256-${{ matrix.arch }}
          path: sha256-${{ matrix.arch }}.txt

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Read SHA256 hashes
        id: hashes
        run: |
          SHA256_ARM=$(cat artifacts/sha256-aarch64/sha256-aarch64.txt)
          SHA256_INTEL=$(cat artifacts/sha256-x86_64/sha256-x86_64.txt)
          echo "sha256_arm=$SHA256_ARM" >> $GITHUB_OUTPUT
          echo "sha256_intel=$SHA256_INTEL" >> $GITHUB_OUTPUT
          echo "ARM SHA256: $SHA256_ARM"
          echo "Intel SHA256: $SHA256_INTEL"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: OpenSCAD Studio v${{ steps.get_version.outputs.version }}
          body: |
            ## Installation

            ```bash
            brew tap zacharyfmarion/openscad-studio
            brew install --cask openscad-studio
            ```

            Or if you already have it installed:
            ```bash
            brew update && brew upgrade openscad-studio
            ```

            See [CHANGELOG.md](https://github.com/zacharyfmarion/openscad-studio/blob/main/CHANGELOG.md) for what's new in this release.
          files: |
            artifacts/dmg-aarch64/*.dmg
            artifacts/dmg-x86_64/*.dmg
          draft: false
          prerelease: false

      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.get_version.outputs.version }}
          SHA256_ARM: ${{ steps.hashes.outputs.sha256_arm }}
          SHA256_INTEL: ${{ steps.hashes.outputs.sha256_intel }}
        run: |
          # Clone the tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/zacharyfmarion/homebrew-openscad-studio.git tap
          cd tap

          # Create the cask formula
          mkdir -p Casks
          cat > Casks/openscad-studio.rb << 'CASK_EOF'
          cask "openscad-studio" do
            arch arm: "aarch64", intel: "x86_64"

            version "VERSION_PLACEHOLDER"
            sha256 arm:   "SHA256_ARM_PLACEHOLDER",
                   intel: "SHA256_INTEL_PLACEHOLDER"

            url "https://github.com/zacharyfmarion/openscad-studio/releases/download/v#{version}/OpenSCAD.Studio_#{version}_#{arch}.dmg",
                verified: "github.com/zacharyfmarion/"

            name "OpenSCAD Studio"
            desc "Modern OpenSCAD editor with live preview and AI copilot"
            homepage "https://github.com/zacharyfmarion/openscad-studio"

            depends_on cask: "openscad"

            app "OpenSCAD Studio.app"

            # Explicitly remove quarantine attribute to bypass Gatekeeper for unsigned apps
            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/OpenSCAD Studio.app"]
              # OpenSCAD installs with versioned names like OpenSCAD-2021.01.app
              Dir.glob("#{appdir}/OpenSCAD*.app").each do |openscad_app|
                system_command "/usr/bin/xattr",
                               args: ["-cr", openscad_app]
              end
            end

            zap trash: [
              "~/Library/Application Support/com.openscad.studio",
              "~/Library/Caches/com.openscad.studio",
              "~/Library/Preferences/com.openscad.studio.plist",
            ]
          end
          CASK_EOF

          # Replace placeholders with actual values
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" Casks/openscad-studio.rb
          sed -i "s/SHA256_ARM_PLACEHOLDER/${SHA256_ARM}/g" Casks/openscad-studio.rb
          sed -i "s/SHA256_INTEL_PLACEHOLDER/${SHA256_INTEL}/g" Casks/openscad-studio.rb

          # Show the result
          echo "Generated cask formula:"
          cat Casks/openscad-studio.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/openscad-studio.rb
          git commit -m "Update openscad-studio to v${VERSION}" || echo "No changes to commit"
          git push
